import { PrismaClient } from '@prisma/client';
import bcrypt from 'bcryptjs';

const prisma = new PrismaClient();

async function main() {
  console.log('üå± Iniciando seeders...');

  // ============================================
  // 1. CREAR ROLES
  // ============================================
  console.log('\nüìã Creando roles...');
  
  const roles = await Promise.all([
    prisma.role.upsert({
      where: { name: 'admin' },
      update: {},
      create: { name: 'admin' },
    }),
    prisma.role.upsert({
      where: { name: 'especialista' },
      update: {},
      create: { name: 'especialista' },
    }),
    prisma.role.upsert({
      where: { name: 'caja' },
      update: {},
      create: { name: 'caja' },
    }),
    prisma.role.upsert({
      where: { name: 'recepcion' },
      update: {},
      create: { name: 'recepcion' },
    }),
    prisma.role.upsert({
      where: { name: 'radiologo' },
      update: {},
      create: { name: 'radiologo' },
    }),
  ]);

  console.log(`‚úÖ ${roles.length} roles creados`);

  // ============================================
  // 2. CREAR ESPECIALIDADES
  // ============================================
  console.log('\nüè• Creando especialidades...');
  
  const specialties = await Promise.all([
    prisma.specialty.upsert({
      where: { name: 'Medicina General' },
      update: {},
      create: {
        name: 'Medicina General',
        description: 'Atenci√≥n m√©dica general y consultas de rutina',
        isActive: true,
      },
    }),
    prisma.specialty.upsert({
      where: { name: 'Pediatr√≠a' },
      update: {},
      create: {
        name: 'Pediatr√≠a',
        description: 'Especialidad enfocada en la salud de ni√±os y adolescentes',
        isActive: true,
      },
    }),
    prisma.specialty.upsert({
      where: { name: 'Cardiolog√≠a' },
      update: {},
      create: {
        name: 'Cardiolog√≠a',
        description: 'Diagn√≥stico y tratamiento de enfermedades del coraz√≥n',
        isActive: true,
      },
    }),
    prisma.specialty.upsert({
      where: { name: 'Dermatolog√≠a' },
      update: {},
      create: {
        name: 'Dermatolog√≠a',
        description: 'Tratamiento de enfermedades de la piel',
        isActive: true,
      },
    }),
    prisma.specialty.upsert({
      where: { name: 'Ginecolog√≠a' },
      update: {},
      create: {
        name: 'Ginecolog√≠a',
        description: 'Salud reproductiva femenina',
        isActive: true,
      },
    }),
    prisma.specialty.upsert({
      where: { name: 'Traumatolog√≠a' },
      update: {},
      create: {
        name: 'Traumatolog√≠a',
        description: 'Lesiones del sistema musculoesquel√©tico',
        isActive: true,
      },
    }),
    prisma.specialty.upsert({
      where: { name: 'Oftalmolog√≠a' },
      update: {},
      create: {
        name: 'Oftalmolog√≠a',
        description: 'Especialidad de salud visual',
        isActive: true,
      },
    }),
  ]);

  console.log(`‚úÖ ${specialties.length} especialidades creadas`);

  // ============================================
  // 3. CREAR USUARIOS
  // ============================================
  console.log('\nüë• Creando usuarios...');
  
  const hashedPassword = await bcrypt.hash('password123', 10);

  const adminRole = roles.find(r => r.name === 'admin');
  const especialistaRole = roles.find(r => r.name === 'especialista');
  const cajaRole = roles.find(r => r.name === 'caja');
  const recepcionRole = roles.find(r => r.name === 'recepcion');

  const medicinaGeneral = specialties.find(s => s.name === 'Medicina General');
  const pediatria = specialties.find(s => s.name === 'Pediatr√≠a');
  const cardiologia = specialties.find(s => s.name === 'Cardiolog√≠a');

  const users = await Promise.all([
    // Administrador
    prisma.user.upsert({
      where: { username: 'admin' },
      update: {},
      create: {
        username: 'admin',
        password: hashedPassword,
        name: 'Administrador del Sistema',
        roleId: adminRole!.id,
        isActive: true,
      },
    }),
    // Especialistas
    prisma.user.upsert({
      where: { username: 'dr.martinez' },
      update: {},
      create: {
        username: 'dr.martinez',
        password: hashedPassword,
        name: 'Dr. Carlos Mart√≠nez',
        roleId: especialistaRole!.id,
        specialtyId: medicinaGeneral!.id,
        isActive: true,
      },
    }),
    prisma.user.upsert({
      where: { username: 'dra.lopez' },
      update: {},
      create: {
        username: 'dra.lopez',
        password: hashedPassword,
        name: 'Dra. Mar√≠a L√≥pez',
        roleId: especialistaRole!.id,
        specialtyId: pediatria!.id,
        isActive: true,
      },
    }),
    prisma.user.upsert({
      where: { username: 'dr.garcia' },
      update: {},
      create: {
        username: 'dr.garcia',
        password: hashedPassword,
        name: 'Dr. Roberto Garc√≠a',
        roleId: especialistaRole!.id,
        specialtyId: cardiologia!.id,
        isActive: true,
      },
    }),
    // Personal de caja
    prisma.user.upsert({
      where: { username: 'caja1' },
      update: {},
      create: {
        username: 'caja1',
        password: hashedPassword,
        name: 'Ana Ram√≠rez',
        roleId: cajaRole!.id,
        isActive: true,
      },
    }),
    // Personal de recepci√≥n
    prisma.user.upsert({
      where: { username: 'recepcion1' },
      update: {},
      create: {
        username: 'recepcion1',
        password: hashedPassword,
        name: 'Laura Hern√°ndez',
        roleId: recepcionRole!.id,
        isActive: true,
      },
    }),
  ]);

  console.log(`‚úÖ ${users.length} usuarios creados`);
  console.log('   üìù Credenciales por defecto: username / password123');

  // ============================================
  // 4. CREAR PACIENTES
  // ============================================
  console.log('\nüè• Creando pacientes...');

  const patients = await Promise.all([
    prisma.patient.upsert({
      where: { identityNumber: '0801-1990-12345' },
      update: {},
      create: {
        firstName: 'Juan',
        lastName: 'P√©rez Gonz√°lez',
        birthDate: new Date('1990-05-15'),
        gender: 'Masculino',
        identityNumber: '0801-1990-12345',
        phone: '9876-5432',
        address: 'Col. Las Colinas, Tegucigalpa',
        emergencyContactName: 'Mar√≠a P√©rez',
        emergencyContactNumber: '9876-5433',
        emergencyContactRelation: 'Esposa',
        medicalHistory: 'Sin antecedentes relevantes',
        allergies: 'Penicilina',
      },
    }),
    prisma.patient.upsert({
      where: { identityNumber: '0801-1985-54321' },
      update: {},
      create: {
        firstName: 'Mar√≠a',
        lastName: 'Rodr√≠guez L√≥pez',
        birthDate: new Date('1985-08-22'),
        gender: 'Femenino',
        identityNumber: '0801-1985-54321',
        phone: '3345-6789',
        address: 'Col. Kennedy, Tegucigalpa',
        emergencyContactName: 'Pedro Rodr√≠guez',
        emergencyContactNumber: '3345-6790',
        emergencyContactRelation: 'Hermano',
        medicalHistory: 'Hipertensi√≥n controlada',
        allergies: 'Ninguna',
      },
    }),
    prisma.patient.upsert({
      where: { identityNumber: '0801-2010-11111' },
      update: {},
      create: {
        firstName: 'Sof√≠a',
        lastName: 'Mart√≠nez Cruz',
        birthDate: new Date('2010-03-10'),
        gender: 'Femenino',
        identityNumber: '0801-2010-11111',
        phone: '2234-5678',
        address: 'Col. Miramontes, Tegucigalpa',
        emergencyContactName: 'Ana Cruz',
        emergencyContactNumber: '2234-5679',
        emergencyContactRelation: 'Madre',
        medicalHistory: 'Saludable',
        allergies: 'Ninguna',
      },
    }),
    prisma.patient.upsert({
      where: { identityNumber: '0801-1978-22222' },
      update: {},
      create: {
        firstName: 'Carlos',
        lastName: 'Hern√°ndez D√≠az',
        birthDate: new Date('1978-11-30'),
        gender: 'Masculino',
        identityNumber: '0801-1978-22222',
        phone: '9988-7766',
        address: 'Res. El Pedregal, Tegucigalpa',
        emergencyContactName: 'Rosa D√≠az',
        emergencyContactNumber: '9988-7767',
        emergencyContactRelation: 'Esposa',
        medicalHistory: 'Diabetes tipo 2',
        allergies: 'Sulfa',
      },
    }),
    prisma.patient.upsert({
      where: { identityNumber: '0801-1995-33333' },
      update: {},
      create: {
        firstName: 'Andrea',
        lastName: 'Flores Mej√≠a',
        birthDate: new Date('1995-07-18'),
        gender: 'Femenino',
        identityNumber: '0801-1995-33333',
        phone: '3312-4567',
        address: 'Col. Rub√©n Dar√≠o, Tegucigalpa',
        emergencyContactName: 'Luis Flores',
        emergencyContactNumber: '3312-4568',
        emergencyContactRelation: 'Padre',
        medicalHistory: 'Asma leve',
        allergies: 'Polen',
      },
    }),
    prisma.patient.upsert({
      where: { identityNumber: '0801-2015-44444' },
      update: {},
      create: {
        firstName: 'Miguel',
        lastName: 'Castro Vargas',
        birthDate: new Date('2015-01-25'),
        gender: 'Masculino',
        identityNumber: '0801-2015-44444',
        phone: '2245-6789',
        address: 'Col. La Granja, Tegucigalpa',
        emergencyContactName: 'Claudia Vargas',
        emergencyContactNumber: '2245-6790',
        emergencyContactRelation: 'Madre',
        medicalHistory: 'Saludable',
        allergies: 'Ninguna',
      },
    }),
    prisma.patient.upsert({
      where: { identityNumber: '0801-1982-55555' },
      update: {},
      create: {
        firstName: 'Roberto',
        lastName: 'S√°nchez Ortiz',
        birthDate: new Date('1982-09-12'),
        gender: 'Masculino',
        identityNumber: '0801-1982-55555',
        phone: '9876-1234',
        address: 'Col. Palmira, Tegucigalpa',
        emergencyContactName: 'Patricia Ortiz',
        emergencyContactNumber: '9876-1235',
        emergencyContactRelation: 'Esposa',
        medicalHistory: 'Colesterol alto',
        allergies: 'Mariscos',
      },
    }),
    prisma.patient.upsert({
      where: { identityNumber: '0801-1998-66666' },
      update: {},
      create: {
        firstName: 'Daniela',
        lastName: 'Morales Reyes',
        birthDate: new Date('1998-04-05'),
        gender: 'Femenino',
        identityNumber: '0801-1998-66666',
        phone: '3389-4567',
        address: 'Col. Lomas del Guijarro, Tegucigalpa',
        emergencyContactName: 'Jos√© Morales',
        emergencyContactNumber: '3389-4568',
        emergencyContactRelation: 'Padre',
        medicalHistory: 'Saludable',
        allergies: 'Ibuprofeno',
      },
    }),
  ]);

  console.log(`‚úÖ ${patients.length} pacientes creados`);

  // ============================================
  // 5. CREAR CITAS
  // ============================================
  console.log('\nüìÖ Creando citas m√©dicas...');

  const today = new Date();
  const yesterday = new Date(today);
  yesterday.setDate(yesterday.getDate() - 1);
  const tomorrow = new Date(today);
  tomorrow.setDate(tomorrow.getDate() + 1);
  const nextWeek = new Date(today);
  nextWeek.setDate(nextWeek.getDate() + 7);

  const appointments = await Promise.all([
    // Citas programadas (futuras)
    prisma.appointment.create({
      data: {
        patientId: patients[0].id,
        specialtyId: medicinaGeneral!.id,
        appointmentDate: tomorrow,
        status: 'programado',
        notes: 'Consulta de control',
      },
    }),
    prisma.appointment.create({
      data: {
        patientId: patients[1].id,
        specialtyId: cardiologia!.id,
        appointmentDate: nextWeek,
        status: 'programado',
        notes: 'Control de presi√≥n arterial',
      },
    }),
    prisma.appointment.create({
      data: {
        patientId: patients[2].id,
        specialtyId: pediatria!.id,
        appointmentDate: tomorrow,
        status: 'programado',
        notes: 'Vacunaci√≥n',
      },
    }),
    // Citas pendientes (hoy)
    prisma.appointment.create({
      data: {
        patientId: patients[3].id,
        specialtyId: medicinaGeneral!.id,
        appointmentDate: today,
        status: 'pendiente',
        notes: 'Consulta general',
      },
    }),
    prisma.appointment.create({
      data: {
        patientId: patients[4].id,
        specialtyId: pediatria!.id,
        appointmentDate: today,
        status: 'pendiente',
        notes: 'Control de asma',
      },
    }),
    // Citas completadas (ayer)
    prisma.appointment.create({
      data: {
        patientId: patients[5].id,
        specialtyId: pediatria!.id,
        appointmentDate: yesterday,
        status: 'completado',
        notes: 'Consulta de rutina',
      },
    }),
    prisma.appointment.create({
      data: {
        patientId: patients[6].id,
        specialtyId: cardiologia!.id,
        appointmentDate: yesterday,
        status: 'completado',
        notes: 'Electrocardiograma',
      },
    }),
    // Cita cancelada
    prisma.appointment.create({
      data: {
        patientId: patients[7].id,
        specialtyId: medicinaGeneral!.id,
        appointmentDate: yesterday,
        status: 'cancelado',
        notes: 'Paciente no se present√≥',
      },
    }),
  ]);

  console.log(`‚úÖ ${appointments.length} citas creadas`);

  // ============================================
  // 6. CREAR TAGS PARA PRECIOS
  // ============================================
  console.log('\nüè∑Ô∏è  Creando tags para sistema de precios...');

  const tags = await Promise.all([
    prisma.tag.upsert({
      where: { name: 'especialidad' },
      update: {},
      create: {
        name: 'especialidad',
        description: 'Servicios espec√≠ficos por especialidad m√©dica',
      },
    }),
    prisma.tag.upsert({
      where: { name: 'hospitalizaciones' },
      update: {},
      create: {
        name: 'hospitalizaciones',
        description: 'Servicios relacionados con hospitalizaci√≥n',
      },
    }),
    prisma.tag.upsert({
      where: { name: 'cirugias' },
      update: {},
      create: {
        name: 'cirugias',
        description: 'Procedimientos quir√∫rgicos',
      },
    }),
    prisma.tag.upsert({
      where: { name: 'rayos_x' },
      update: {},
      create: {
        name: 'rayos_x',
        description: 'Estudios radiol√≥gicos',
      },
    }),
    prisma.tag.upsert({
      where: { name: 'otros' },
      update: {},
      create: {
        name: 'otros',
        description: 'Otros servicios m√©dicos',
      },
    }),
  ]);

  console.log(`‚úÖ ${tags.length} tags creados`);

  // ============================================
  // 7. CREAR PRECIOS - Usar seeder separado
  // ============================================
  console.log('\nüí∞ Para crear precios, ejecuta: npx tsx prisma/seed-prices.ts');
  const totalPrices = await prisma.serviceItem.count();

  console.log('\n‚úÖ ¬°Seeders completados exitosamente!\n');
  console.log('üìä Resumen:');
  console.log(`   - ${roles.length} roles`);
  console.log(`   - ${specialties.length} especialidades`);
  console.log(`   - ${users.length} usuarios`);
  console.log(`   - ${patients.length} pacientes`);
  console.log(`   - ${appointments.length} citas`);
  console.log(`   - ${tags.length} tags`);
  console.log(`   - ${totalPrices} precios\n`);
  console.log('üîë Credenciales de acceso:');
  console.log('   Admin: admin / password123');
  console.log('   Especialista: dr.martinez / password123');
  console.log('   Caja: caja1 / password123');
  console.log('   Recepci√≥n: recepcion1 / password123\n');
}

// Exportar main para uso en otros scripts
export { main };

// Solo ejecutar si se llama directamente
if (require.main === module) {
  main()
    .catch((e) => {
      console.error('‚ùå Error ejecutando seeders:', e);
      process.exit(1);
    })
    .finally(async () => {
      await prisma.$disconnect();
    });
}
