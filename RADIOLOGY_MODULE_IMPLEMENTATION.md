# üè• M√≥dulo de Radiolog√≠a - Implementaci√≥n Completa

**Fecha**: 14 de Octubre, 2025  
**Estado**: ‚úÖ **BACKEND COMPLETADO**

---

## üìã Resumen

Se ha implementado el m√≥dulo completo de radiolog√≠a con el siguiente flujo:

**FLUJO DE TRABAJO:**
1. üí∞ **Caja** ‚Üí Cobra al paciente y crea pago de tipo `radiology`
2. üîÑ **Sistema** ‚Üí Autom√°ticamente crea `RadiologyOrder` vinculada al pago
3. üë®‚Äç‚öïÔ∏è **Radi√≥logo** ‚Üí Ve √≥rdenes pendientes en su panel
4. üìã **Radi√≥logo** ‚Üí Realiza estudio, registra hallazgos y diagn√≥stico
5. ‚úÖ **Radi√≥logo** ‚Üí Marca como completado y sube im√°genes (opcional)

---

## ‚úÖ Cambios Realizados

### 1. **Schema de Base de Datos** ‚úÖ

**Archivo**: `prisma/schema.prisma`

#### Nuevo Modelo: `RadiologyOrder`

```prisma
model RadiologyOrder {
  id              String   @id @default(cuid())
  patientId       String
  paymentId       String   @unique // Relaci√≥n 1:1 con Payment
  
  // Estado de la orden
  status          String   @default("pending") // pending, in_progress, completed, cancelled
  
  // Resultados y observaciones
  findings        String?  @db.Text // Hallazgos radiol√≥gicos
  diagnosis       String?  @db.Text // Impresi√≥n diagn√≥stica
  images          String?  @db.Text // JSON con URLs de im√°genes subidas
  performedBy     String?  // ID del radi√≥logo que realiz√≥ el estudio
  
  // Metadata
  notes           String?  @db.Text // Notas adicionales
  completedAt     DateTime? // Fecha de finalizaci√≥n del estudio
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relaciones
  patient         Patient  @relation(fields: [patientId], references: [id])
  payment         Payment  @relation(fields: [paymentId], references: [id])
  
  @@map("radiology_orders")
}
```

#### Relaciones Actualizadas:

**`Payment`** ‚Üí Agregado:
```prisma
radiologyOrder  RadiologyOrder?  // Nueva relaci√≥n con √≥rdenes de radiolog√≠a
```

**`Patient`** ‚Üí Agregado:
```prisma
radiologyOrders  RadiologyOrder[] // √ìrdenes de radiolog√≠a del paciente
```

---

### 2. **TypeScript Types** ‚úÖ

**Archivo**: `src/types/radiology.ts` (NUEVO)

```typescript
export type RadiologyOrderStatus = 'pending' | 'in_progress' | 'completed' | 'cancelled';

export interface RadiologyOrder {
  id: string;
  patientId: string;
  paymentId: string;
  status: RadiologyOrderStatus;
  findings?: string | null;
  diagnosis?: string | null;
  images?: string | null;
  performedBy?: string | null;
  notes?: string | null;
  completedAt?: Date | null;
  createdAt: Date;
  updatedAt: Date;
}

export interface RadiologyOrderWithRelations extends RadiologyOrder {
  patient: {
    id: string;
    firstName: string;
    lastName: string;
    identityNumber: string;
    birthDate: Date;
    gender: string;
  };
  payment: {
    id: string;
    total: number;
    status: string;
    createdAt: Date;
  };
  performer?: {
    id: string;
    name: string;
  } | null;
}

export interface CreateRadiologyOrderData {
  patientId: string;
  paymentId: string;
  notes?: string;
}

export interface UpdateRadiologyOrderData {
  status?: RadiologyOrderStatus;
  findings?: string;
  diagnosis?: string;
  images?: string;
  performedBy?: string;
  notes?: string;
  completedAt?: Date | string;
}
```

**Archivo**: `src/types/payments.ts` (MODIFICADO)

```typescript
// Agregado tipo de pago
export type PaymentSourceType = 'consultation' | 'sale' | 'hospitalization' | 'radiology';

// Agregado par√°metro type
export interface CreatePaymentData {
  patientId: string;
  items: CreatePaymentItemData[];
  notes?: string;
  type?: 'sale' | 'radiology'; // NUEVO
}
```

**Archivo**: `src/types/index.ts` (MODIFICADO)

```typescript
// Exportados tipos de radiolog√≠a
export type {
  RadiologyOrderStatus,
  RadiologyOrder,
  RadiologyOrderWithRelations,
  CreateRadiologyOrderData,
  UpdateRadiologyOrderData,
  RadiologyOrderListItem,
  RadiologyOrderModalProps,
  RadiologyResultsModalProps
} from './radiology';
```

---

### 3. **API Endpoints** ‚úÖ

#### **GET `/api/radiology`** - Listar √≥rdenes de radiolog√≠a

**Par√°metros de query**:
- `patientId` (opcional): Filtrar por paciente
- `status` (opcional): Filtrar por estado
- `search` (opcional): Buscar por nombre/identidad de paciente
- `page` (opcional, default: 1): P√°gina actual
- `limit` (opcional, default: 20): Registros por p√°gina

**Respuesta**:
```json
{
  "orders": [
    {
      "id": "...",
      "patientId": "...",
      "paymentId": "...",
      "status": "pending",
      "createdAt": "...",
      "patient": { "firstName": "...", "lastName": "..." },
      "payment": { "total": 500, "status": "pendiente" }
    }
  ],
  "pagination": {
    "currentPage": 1,
    "totalPages": 5,
    "totalCount": 50,
    "hasNextPage": true,
    "hasPreviousPage": false,
    "limit": 20
  }
}
```

---

#### **POST `/api/radiology`** - Crear orden de radiolog√≠a

**Nota**: Normalmente NO se usa directamente, se crea autom√°ticamente desde pagos.

**Body**:
```json
{
  "patientId": "...",
  "paymentId": "...",
  "notes": "Orden manual"
}
```

---

#### **GET `/api/radiology/[id]`** - Obtener orden espec√≠fica

**Respuesta**:
```json
{
  "id": "...",
  "patientId": "...",
  "paymentId": "...",
  "status": "pending",
  "findings": null,
  "diagnosis": null,
  "images": null,
  "performedBy": null,
  "notes": "...",
  "completedAt": null,
  "createdAt": "...",
  "patient": {
    "id": "...",
    "firstName": "Juan",
    "lastName": "P√©rez",
    "identityNumber": "0801-1990-12345",
    "phone": "98765432"
  },
  "payment": {
    "id": "...",
    "total": 500,
    "status": "pendiente"
  }
}
```

---

#### **PATCH `/api/radiology/[id]`** - Actualizar orden

**Body** (todos opcionales):
```json
{
  "status": "in_progress",
  "findings": "Campos pulmonares despejados...",
  "diagnosis": "Radiograf√≠a de t√≥rax normal",
  "images": "[{\"url\": \"...\", \"type\": \"rayos_x\"}]",
  "notes": "Notas adicionales"
}
```

**L√≥gica autom√°tica**:
- Si `status === 'completed'`:
  - Guarda `completedAt = now()`
  - Guarda `performedBy = session.user.id`
- Si se agregan `findings`, `diagnosis` o `images` y estado es `pending`:
  - Cambia autom√°ticamente a `in_progress`
  - Guarda `performedBy = session.user.id`

---

#### **DELETE `/api/radiology/[id]`** - Cancelar orden

**Validaciones**:
- ‚ùå No permite cancelar √≥rdenes `completed`
- ‚úÖ Cambia estado a `cancelled`

---

#### **POST `/api/payments`** - MODIFICADO para radiolog√≠a

**Body** (agregado campo `type`):
```json
{
  "patientId": "...",
  "items": [
    {
      "priceId": "...",
      "nombre": "Rayos X de T√≥rax",
      "precioUnitario": 500,
      "quantity": 1
    }
  ],
  "type": "radiology",  // ‚Üê NUEVO: "sale" o "radiology"
  "notes": "Orden de rayos x"
}
```

**L√≥gica autom√°tica**:
1. Crea el `Payment` normal
2. **SI `type === 'radiology'`**:
   - Crea autom√°ticamente `RadiologyOrder` vinculada
   - Estado inicial: `pending`
   - Devuelve la orden en la respuesta

**Respuesta**:
```json
{
  "id": "payment-id",
  "patientId": "...",
  "saleId": "...",
  "total": 500,
  "status": "pendiente",
  "items": [...],
  "radiologyOrder": {  // ‚Üê NUEVO: Solo si type === "radiology"
    "id": "order-id",
    "patientId": "...",
    "paymentId": "payment-id",
    "status": "pending",
    "createdAt": "..."
  }
}
```

---

## üîÑ Flujo Completo de Uso

### 1. **Caja: Crear Pago de Radiolog√≠a**

```typescript
// Desde el m√≥dulo de pagos/caja
const response = await fetch('/api/payments', {
  method: 'POST',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    patientId: 'patient-123',
    items: [
      {
        priceId: 'price-rayosx',
        nombre: 'Rayos X de T√≥rax PA y Lateral',
        precioUnitario: 500,
        quantity: 1
      }
    ],
    type: 'radiology', // ‚Üê IMPORTANTE
    notes: 'Orden de rayos x de t√≥rax'
  })
});

const data = await response.json();
// data.radiologyOrder.id ‚Üí ID de la orden creada autom√°ticamente
```

---

### 2. **Radi√≥logo: Ver √ìrdenes Pendientes**

```typescript
// Desde el m√≥dulo de radiolog√≠a
const response = await fetch('/api/radiology?status=pending');
const { orders, pagination } = await response.json();

// Mostrar lista de √≥rdenes pendientes
orders.forEach(order => {
  console.log(`Paciente: ${order.patient.firstName} ${order.patient.lastName}`);
  console.log(`Total pagado: L ${order.payment.total}`);
  console.log(`Estado: ${order.status}`);
});
```

---

### 3. **Radi√≥logo: Iniciar Estudio**

```typescript
// Cuando el radi√≥logo empieza a trabajar en la orden
const response = await fetch(`/api/radiology/${orderId}`, {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    findings: 'Iniciando estudio...',
    // Al agregar findings, status cambia autom√°ticamente a "in_progress"
  })
});
```

---

### 4. **Radi√≥logo: Completar Estudio**

```typescript
// Cuando termina el estudio
const response = await fetch(`/api/radiology/${orderId}`, {
  method: 'PATCH',
  headers: { 'Content-Type': 'application/json' },
  body: JSON.stringify({
    status: 'completed',
    findings: `
      HALLAZGOS:
      - Campos pulmonares despejados
      - Silueta card√≠aca normal
      - Sin infiltrados ni consolidaciones
    `,
    diagnosis: 'Radiograf√≠a de t√≥rax PA y Lateral: SIN ALTERACIONES',
    images: JSON.stringify([
      { url: '/uploads/xray-123-pa.jpg', type: 'PA' },
      { url: '/uploads/xray-123-lateral.jpg', type: 'Lateral' }
    ])
  })
});

// El sistema autom√°ticamente guarda:
// - completedAt: now()
// - performedBy: session.user.id
```

---

## üìä Estados de √ìrdenes

| Estado | Descripci√≥n | Puede cambiar a |
|--------|-------------|-----------------|
| **pending** | Orden creada, esperando atenci√≥n | `in_progress`, `cancelled` |
| **in_progress** | Radi√≥logo trabajando en el estudio | `completed`, `cancelled` |
| **completed** | Estudio completado con resultados | ‚ùå (final) |
| **cancelled** | Orden cancelada | ‚ùå (final) |

---

## üé® Frontend Pendiente

### Componentes a Crear:

1. **M√≥dulo de Caja - Actualizado**
   ```tsx
   // Agregar opci√≥n para seleccionar tipo de pago
   <Select value={paymentType} onChange={setPaymentType}>
     <option value="sale">Venta Normal</option>
     <option value="radiology">Rayos X / Radiolog√≠a</option>
   </Select>
   ```

2. **P√°gina de Radiolog√≠a** (`/radiologia`)
   ```tsx
   // src/app/radiologia/page.tsx
   - Lista de √≥rdenes pendientes
   - Filtros por estado
   - B√∫squeda por paciente
   ```

3. **Modal de Resultados de Radiolog√≠a**
   ```tsx
   // src/components/RadiologyResultsModal.tsx
   - Formulario para ingresar hallazgos
   - Campo de diagn√≥stico
   - Subida de im√°genes
   - Bot√≥n para marcar como completado
   ```

4. **Vista Detallada de Orden**
   ```tsx
   // src/app/radiologia/[id]/page.tsx
   - Informaci√≥n del paciente
   - Detalles del pago
   - Formulario de resultados
   - Galer√≠a de im√°genes
   ```

---

## üîê Permisos y Seguridad

### Roles con Acceso:

| Rol | Ver √ìrdenes | Crear Pago Radiolog√≠a | Actualizar Orden | Completar Estudio |
|-----|-------------|----------------------|------------------|-------------------|
| **admin** | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| **radiologo** | ‚úÖ | ‚ùå | ‚úÖ | ‚úÖ |
| **caja** | ‚ùå | ‚úÖ | ‚ùå | ‚ùå |
| **especialista** | ‚ùå | ‚ùå | ‚ùå | ‚ùå |
| **recepcion** | ‚ùå | ‚ùå | ‚ùå | ‚ùå |

---

## üìÅ Archivos Creados/Modificados

```
zucli/
‚îú‚îÄ‚îÄ prisma/
‚îÇ   ‚îî‚îÄ‚îÄ schema.prisma                          ‚úèÔ∏è MODIFICADO (agregado RadiologyOrder)
‚îÇ
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ radiology.ts                       ‚úÖ NUEVO
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ payments.ts                        ‚úèÔ∏è MODIFICADO (agregado type)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts                           ‚úèÔ∏è MODIFICADO (exportar radiology)
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ app/api/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ radiology/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ route.ts                       ‚úÖ NUEVO (GET, POST)
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ [id]/
‚îÇ   ‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts                   ‚úÖ NUEVO (GET, PATCH, DELETE)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ payments/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ route.ts                       ‚úèÔ∏è MODIFICADO (l√≥gica radiolog√≠a)
‚îÇ   ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ (frontend pendiente)
‚îÇ       ‚îú‚îÄ‚îÄ app/radiologia/page.tsx            ‚è≥ PENDIENTE
‚îÇ       ‚îú‚îÄ‚îÄ app/radiologia/[id]/page.tsx       ‚è≥ PENDIENTE
‚îÇ       ‚îî‚îÄ‚îÄ components/
‚îÇ           ‚îú‚îÄ‚îÄ RadiologyOrdersList.tsx        ‚è≥ PENDIENTE
‚îÇ           ‚îú‚îÄ‚îÄ RadiologyResultsModal.tsx      ‚è≥ PENDIENTE
‚îÇ           ‚îî‚îÄ‚îÄ RadiologyOrderCard.tsx         ‚è≥ PENDIENTE
‚îÇ
‚îî‚îÄ‚îÄ RADIOLOGY_MODULE_IMPLEMENTATION.md         ‚úÖ NUEVO (este archivo)
```

---

## üöÄ Pr√≥ximos Pasos

### **Prioridad Alta** (2-3 horas):

1. **‚úÖ Crear interfaz de Caja**
   - Agregar selector de tipo de pago ("Venta" / "Radiolog√≠a")
   - Mostrar confirmaci√≥n cuando se crea orden de radiolog√≠a
   - Tiempo: 30 min

2. **‚úÖ Crear p√°gina de Radiolog√≠a** (`/radiologia`)
   - Lista de √≥rdenes con filtros
   - Estados visuales (pending, in_progress, completed)
   - B√∫squeda de pacientes
   - Tiempo: 1 hora

3. **‚úÖ Crear Modal de Resultados**
   - Formulario para hallazgos y diagn√≥stico
   - Textarea para findings
   - Textarea para diagnosis
   - Bot√≥n "Marcar como Completado"
   - Tiempo: 45 min

4. **‚úÖ Agregar a Navegaci√≥n**
   - Agregar "Radiolog√≠a" al men√∫ del radi√≥logo
   - √çcono: `<Scan size={20} />`
   - Tiempo: 15 min

---

### **Prioridad Media** (1-2 horas):

5. **Subida de Im√°genes**
   - Integrar con storage (S3, Cloudinary, etc.)
   - Galer√≠a de im√°genes en resultados
   - Visor de im√°genes radiol√≥gicas
   - Tiempo: 2 horas

6. **Dashboard de Radi√≥logo**
   - Estad√≠sticas de estudios
   - √ìrdenes pendientes del d√≠a
   - Tiempo promedio por estudio
   - Tiempo: 1 hora

---

### **Prioridad Baja** (mejoras futuras):

7. **Plantillas de Informes**
   - Templates predefinidos por tipo de estudio
   - Autocompletado de campos comunes
   - Tiempo: 1 hora

8. **Notificaciones**
   - Notificar al radi√≥logo cuando hay nueva orden
   - Notificar al especialista cuando se completa
   - Tiempo: 1 hora

9. **Reportes y Estad√≠sticas**
   - Estudios por per√≠odo
   - Estudios por radi√≥logo
   - Tiempos de respuesta
   - Tiempo: 2 horas

---

## üéì Comandos de Desarrollo

### Verificar schema:
```bash
pnpm db:push
```

### Ejecutar tests:
```bash
pnpm test
```

### Generar cliente Prisma:
```bash
npx prisma generate
```

---

## ‚úÖ Checklist de Implementaci√≥n

### Backend:
- [x] Modelo `RadiologyOrder` en schema
- [x] Relaciones en `Patient` y `Payment`
- [x] Migraci√≥n de base de datos
- [x] Tipos TypeScript
- [x] API `/api/radiology` (GET, POST)
- [x] API `/api/radiology/[id]` (GET, PATCH, DELETE)
- [x] Modificar `/api/payments` para radiolog√≠a
- [x] L√≥gica autom√°tica de creaci√≥n de √≥rdenes

### Frontend:
- [ ] **Actualizar m√≥dulo de Caja**
- [ ] **Crear p√°gina `/radiologia`**
- [ ] **Crear componentes de radiolog√≠a**
- [ ] **Agregar a navegaci√≥n**
- [ ] **Subida de im√°genes**
- [ ] **Dashboard de radi√≥logo**

---

## üéâ Conclusi√≥n

El **backend del m√≥dulo de radiolog√≠a est√° 100% completo** y listo para usar.

**‚úÖ Implementado:**
- Base de datos con `RadiologyOrder`
- APIs completas para CRUD
- Creaci√≥n autom√°tica desde pagos
- Estados y transiciones
- Type-safety completo

**‚è≥ Siguiente paso:**
Crear la interfaz de usuario (frontend) para que caja y radi√≥logos puedan usar el sistema.

---

*Generado el 14 de Octubre, 2025*

